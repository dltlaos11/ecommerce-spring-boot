# 부하 테스트 계획서

## 📋 개요

이커머스 시스템의 핵심 API에 대한 부하 테스트를 통해 성능 한계를 파악하고 병목 지점을 식별합니다.

## 🎯 테스트 목표

1. **성능 한계 파악**: 시스템이 안정적으로 처리할 수 있는 최대 TPS 확인
2. **병목 지점 식별**: API별 상대적 성능 차이 분석 및 병목 구간 발견
3. **응답 시간 분석**: P95, P99 응답 시간 측정 및 SLA 준수 여부 확인
4. **에러율 모니터링**: 부하 증가 시 에러 발생 패턴 분석
5. **리소스 사용률 분석**: CPU, 메모리, DB 커넥션 등 리소스 사용 패턴 파악

## 🔍 테스트 대상 API 선정

### 1차 우선순위 (핵심 비즈니스)

| API           | 엔드포인트                      | 선정 이유                   | 예상 트래픽 비중 |
| ------------- | ------------------------------- | --------------------------- | ---------------- |
| **주문 생성** | `POST /api/v1/orders`           | 매출 직결, 동시성 이슈 높음 | 15%              |
| **쿠폰 발급** | `POST /api/coupons/async/issue` | 선착순 이벤트, 트래픽 급증  | 10%              |

### 2차 우선순위 (높은 트래픽)

| API                | 엔드포인트                           | 선정 이유                   | 예상 트래픽 비중 |
| ------------------ | ------------------------------------ | --------------------------- | ---------------- |
| **상품 목록 조회** | `GET /api/v1/products`               | 최고 트래픽, 캐싱 효과 검증 | 60%              |
| **주문 조회**      | `GET /api/v1/orders/users/{userId}`  | 주문 후 확인, 복잡 쿼리     | 10%              |
| **잔액 조회**      | `GET /api/v1/users/{userId}/balance` | 결제 전 필수 확인           | 5%               |

## 📊 테스트 시나리오 설계

### 시나리오 1: Load Test (일반 상황)

```yaml
목적: 일상적인 트래픽 처리 능력 확인
가상 사용자: 100명
지속 시간: 5분
단계별 증가: 2분 증가 → 3분 유지 → 2분 감소
목표 SLA:
  - P95 응답시간: 2초 이하
  - 에러율: 1% 이하
  - 처리량: 200 TPS 이상
```

### 시나리오 2: Stress Test (한계 측정)

```yaml
목적: 시스템 한계점 및 실패 지점 확인
가상 사용자: 100명 → 500명 → 1000명
지속 시간: 10분
단계별 증가: 매 2분마다 점진적 증가
측정 지표:
  - 한계 TPS 확인
  - 에러 발생 임계점
  - 복구 시간 측정
```

### 시나리오 3: Peak Test (급증 트래픽)

```yaml
목적: 쿠폰 이벤트와 같은 순간 트래픽 급증 상황 시뮬레이션
가상 사용자: 10초 내 1000명 급증
지속 시간: 2분
패턴: 급속 증가 → 1분 유지 → 급속 감소
핵심 측정:
  - 쿠폰 발급 API 처리 능력
  - Redis 큐잉 효과
  - 시스템 복구 시간
```

## 💡 현실적 사용자 행동 패턴

### E-Commerce 사용자 플로우

```yaml
일반 사용자 (70%): 1. 상품 목록 조회 (100%)
  2. 상품 상세 조회 (60%)
  3. 로그인 (30%)
  4. 잔액 조회 (25%)

구매 의도 사용자 (25%): 1. 상품 검색 (100%)
  2. 로그인 (80%)
  3. 잔액 조회 (100%)
  4. 주문 생성 (90%)
  5. 주문 조회 (100%)

이벤트 참여 사용자 (5%): 1. 쿠폰 발급 (100%)
  2. 상품 조회 (100%)
  3. 즉시 주문 시도 (70%)
```

### 트래픽 분산 비율

- 상품 조회: 60%
- 주문 생성: 15%
- 쿠폰 발급: 10%
- 주문 조회: 8%
- 잔액 조회: 5%
- 기타: 2%

## 🛠️ 테스트 환경 설정

### 시스템 환경

```yaml
서버: localhost:8080 (개발 환경)
데이터베이스: MySQL (로컬)
캐시: Redis (로컬)
메시지 큐: Kafka (로컬)

JVM 설정:
  - Heap Size: 1GB
  - GC: G1GC

DB 설정:
  - 커넥션 풀: HikariCP 16개
  - 타임아웃: 30초
```

### Docker 리소스 제한 테스트 (선택사항)

```bash
# 제한된 리소스 환경
docker run --cpus="1.0" --memory="512m" app

# 표준 리소스 환경
docker run --cpus="2.0" --memory="1g" app

# 고성능 리소스 환경
docker run --cpus="4.0" --memory="2g" app
```

## 📈 측정 지표 및 임계값

### 핵심 성능 지표

| 지표              | 목표값  | 경고 임계값 | 위험 임계값 |
| ----------------- | ------- | ----------- | ----------- |
| **평균 응답시간** | < 500ms | 1초         | 2초         |
| **P95 응답시간**  | < 1초   | 2초         | 5초         |
| **P99 응답시간**  | < 2초   | 5초         | 10초        |
| **처리량 (TPS)**  | > 200   | < 150       | < 100       |
| **에러율**        | < 1%    | 5%          | 10%         |
| **CPU 사용률**    | < 70%   | 80%         | 90%         |
| **메모리 사용률** | < 70%   | 80%         | 90%         |

### API별 목표 SLA

```yaml
상품 조회 API:
  - P95: 500ms 이하
  - 에러율: 0.1% 이하
  - 기대 TPS: 300+

주문 생성 API:
  - P95: 2초 이하
  - 에러율: 1% 이하
  - 기대 TPS: 50+

쿠폰 발급 API:
  - P95: 3초 이하
  - 에러율: 2% 이하 (선착순 특성)
  - 기대 TPS: 200+
```

## 📋 테스트 실행 계획

### 1단계: 환경 준비 (30분)

- [x] K6 설치 및 설정
- [ ] 애플리케이션 시작 확인
- [ ] 기본 API 동작 확인
- [ ] 테스트 데이터 준비

### 2단계: Load Test 실행 (60분)

- [ ] 기본 Load Test 시나리오 실행
- [ ] 결과 수집 및 1차 분석
- [ ] 로그 및 메트릭 수집

### 3단계: Stress Test 실행 (60분)

- [ ] 점진적 부하 증가 테스트
- [ ] 한계점 측정
- [ ] 실패 지점 분석

### 4단계: Peak Test 실행 (30분)

- [ ] 급증 트래픽 시뮬레이션
- [ ] 쿠폰 발급 시나리오 집중 테스트
- [ ] Redis 큐잉 효과 확인

### 5단계: 결과 분석 및 보고서 작성 (120분)

- [ ] 성능 지표 종합 분석
- [ ] 병목 지점 식별
- [ ] 개선 방안 도출
- [ ] 상세 보고서 작성

## 🚨 주의사항

### 필수 준수사항

- **운영 환경 테스트 절대 금지**: 개발/알파 환경에서만 실행
- **DB 백업 확인**: 테스트 전 데이터베이스 백업 상태 확인
- **리소스 모니터링**: 시스템 리소스 실시간 모니터링
- **긴급 중단 계획**: 시스템 과부하 시 즉시 테스트 중단

### 위험 요소 관리

1. **메모리 부족**: OOM 발생 시 애플리케이션 재시작
2. **DB 커넥션 고갈**: 커넥션 풀 포화 시 대기 시간 증가
3. **디스크 공간 부족**: 로그 파일 크기 모니터링
4. **네트워크 대역폭**: localhost 테스트로 네트워크 영향 최소화

## 📊 예상 결과 가설

### 성능 예상치

```yaml
예상 병목 순서:
1. 주문 생성 API (DB 트랜잭션, 외부 API 호출)
2. 쿠폰 발급 API (Redis + Kafka 처리 시간)
3. 주문 조회 API (복잡한 JOIN 쿼리)
4. 상품 조회 API (높은 캐시 히트율로 양호 예상)

예상 한계점:
- 전체 시스템: 500 TPS
- 주문 API: 100 TPS
- 쿠폰 API: 300 TPS
- 조회 API: 800 TPS
```

### 개선 포인트 가설

1. **DB 인덱스 최적화**: 주문 조회 쿼리 성능 개선
2. **커넥션 풀 튜닝**: 동시 처리 능력 향상
3. **캐시 전략**: 상품 조회 API 응답시간 단축
4. **비동기 처리**: 주문 프로세스 일부 비동기화
