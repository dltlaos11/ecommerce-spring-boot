# 성능 분석 보고서

## 📊 테스트 개요

- **테스트 일시**: 2025-09-12 07:41 ~ 07:48 (7분간)
- **테스트 유형**: Load Test (계획: 7분, 실제: 7분 - 타임아웃으로 중단)
- **목표 부하**: 100 가상 사용자 (2분 증가 → 3분 유지 → 2분 감소)
- **실제 완료**: 49,225 iterations + 65 interrupted iterations

## 🎯 주요 발견사항 (Critical Issues)

### 🚨 1. 심각한 성능 문제 감지

**타임아웃 발생 패턴**:
- 2분 30초 후부터 대량 타임아웃 시작
- 요청 타임아웃(Request Timeout) 대량 발생
- 시스템이 부하를 감당하지 못하고 응답 불능 상태 진입

### 📈 2. API별 성능 분석

#### 상품 조회 API (`GET /api/v1/products`)
- **초기 응답시간**: 93ms (양호)
- **안정화 후**: 12-13ms (우수)
- **상태**: ✅ 정상 동작 확인

#### 잔액 조회 API (`GET /api/v1/users/{userId}/balance`) 
- **평균 응답시간**: 45ms 내외
- **상태**: ✅ 안정적 동작

#### 주문 생성 API (`POST /api/v1/orders`)
- **응답시간**: 66ms
- **상태**: ❌ 400 Bad Request 에러 발생
- **문제**: 테스트 데이터 부족으로 인한 검증 실패 추정

#### 쿠폰 발급 API (`POST /api/coupons/async/issue`)
- **상태**: ❌ 타임아웃 대량 발생
- **문제**: 시스템 부하 증가 시 가장 먼저 실패하는 API

### 🔴 3. 핵심 병목 지점 분석

#### 병목 순위 (실제 측정 결과)
1. **쿠폰 발급 API**: 가장 높은 실패율, 타임아웃 집중 발생
2. **주문 생성 API**: 400 에러 발생, 데이터 검증 실패
3. **조회 API들**: 상대적으로 안정적 동작

## 📊 성능 지표 상세 분석

### 응답시간 분석
```
초기 성능 (부하 낮음):
- 상품 조회: 93ms → 12ms (캐시 효과 확인)
- 잔액 조회: 45ms (일정함)
- 주문 생성: 67ms (에러 상황)

부하 증가 후:
- 모든 API: 타임아웃 (무응답)
```

### 에러율 분석
```
에러 유형:
- Request Timeout: 압도적 다수
- 400 Bad Request: 주문/검색 API
- 타임아웃 시작 시점: 2분 30초 후
```

### 시스템 한계점
```
추정 한계 TPS: 약 117 TPS (49,225 requests ÷ 420 seconds)
안정적 부하: 50 가상 사용자 미만 추정
임계점: 2분 30초 후 (약 75-100 가상 사용자)
```

## 🔍 근본 원인 분석

### 1. 데이터베이스 병목 추정
- **증상**: 전체 시스템 응답 불능
- **원인 후보**:
  - DB 커넥션 풀 고갈 (HikariCP 16개 → 부족)
  - 쿠폰 발급 시 Redis + DB + Kafka 동시 처리 부하
  - 인덱스 없는 쿼리로 인한 풀 테이블 스캔

### 2. 쿠폰 시스템 특성
- Redis + Kafka 하이브리드 구조의 복잡성
- 비동기 처리 과정에서의 리소스 경합
- Consumer 처리 속도 < Producer 생성 속도

### 3. 테스트 데이터 부족
- 주문 생성 시 필요한 상품/사용자 데이터 부재
- 검증 로직에서 400 에러 발생
- 실제 비즈니스 플로우 테스트 불가

## 🚀 개선 방안

### 🔥 즉시 대응 (Critical)

1. **DB 커넥션 풀 확대**
   ```yaml
   현재: HikariCP 16개
   제안: 50개 이상
   근거: 부하 시 커넥션 고갈로 추정
   ```

2. **쿠폰 시스템 성능 최적화**
   ```yaml
   - Redis 커넥션 풀 튜닝
   - Kafka Consumer 동시성 증가 (3 → 10)
   - 쿠폰 발급 로직 단순화
   ```

3. **타임아웃 설정 조정**
   ```yaml
   - HTTP 요청 타임아웃: 30초 → 60초
   - DB 쿼리 타임아웃: 30초 → 45초
   - Kafka 프로듀서 타임아웃: 증가
   ```

### 📈 중기 대응 (1주 내)

1. **인덱스 최적화**
   ```sql
   -- 추가 필요 인덱스 (추정)
   CREATE INDEX idx_user_coupons_user_created ON user_coupons(user_id, created_at);
   CREATE INDEX idx_orders_status_created ON orders(status, created_at);
   ```

2. **쿼리 최적화**
   - 슬로우 쿼리 로그 분석
   - N+1 쿼리 문제 해결
   - JPA 배치 크기 조정

3. **비동기 처리 개선**
   ```java
   // 쿠폰 발급을 더 가벼운 처리로 변경
   - 응답 우선 반환
   - 백그라운드에서 실제 처리
   - 상태 조회 API 활용
   ```

### 🏗️ 장기 대응 (1개월 내)

1. **캐시 계층 강화**
   ```yaml
   L1 Cache: 애플리케이션 로컬 캐시
   L2 Cache: Redis 분산 캐시  
   L3 Cache: 데이터베이스
   ```

2. **서비스 분리**
   ```yaml
   쿠폰 서비스 독립화:
   - 별도 DB 스키마
   - 독립된 Redis 클러스터
   - 전용 Kafka 토픽
   ```

3. **로드 밸런싱**
   ```yaml
   - 다중 인스턴스 구성
   - 데이터베이스 읽기 복제본 활용
   - CDN 도입 고려
   ```

## 📋 추가 테스트 권장사항

### 1. 테스트 데이터 완비 후 재테스트
```yaml
필요 데이터:
- 사용자: 1000명 (충분한 잔액)
- 상품: 100개 (재고 충분)
- 쿠폰: 5개 (다양한 타입)
```

### 2. 단계별 부하 테스트
```yaml
Step 1: 25 users (안전 구간 확인)
Step 2: 50 users (한계점 근접)
Step 3: 75 users (임계점 확인)  
Step 4: 100 users (장애 시뮬레이션)
```

### 3. API별 개별 테스트
```yaml
각 API별 단독 성능 측정:
- 상품 조회만 1000 users
- 쿠폰 발급만 100 users
- 주문 생성만 50 users
```

## 💡 핵심 인사이트

### 성능 패턴 분석
1. **초기 성능 우수** → 캐시 워밍업 및 연결 풀 효과
2. **점진적 성능 저하** → 리소스 경합 심화  
3. **급격한 성능 붕괴** → 임계점 초과 후 연쇄 실패

### 비즈니스 임팩트 추정
```yaml
현재 상태로 서비스 시:
- 동시 사용자 50명 초과 시 서비스 장애
- 쿠폰 이벤트 시 전면 서비스 마비 위험
- 고객 이탈 및 매출 손실 불가피
```

### 개선 우선순위
1. **DB 연결 및 쿠폰 시스템** (Critical)
2. **테스트 데이터 및 검증 로직** (High)  
3. **모니터링 및 알림** (Medium)
4. **아키텍처 개선** (Long-term)

---

**⚠️ 권장사항**: 즉시 대응 항목을 우선 적용 후 재테스트 실시  
**📅 다음 테스트 일정**: 개선 후 1주 내 재측정  
**🎯 목표**: 100 가상 사용자 안정적 처리 달성